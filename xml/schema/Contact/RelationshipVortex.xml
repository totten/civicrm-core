<?xml version="1.0" encoding="iso-8859-1" ?>

<table>
  <base>CRM/Contact</base>
  <class>RelationshipVortex</class>
  <name>civicrm_relationship_vtx</name>
  <comment>The vortex permutes information from the relationship table to facilitate querying. Every relationship is mapped to multiple records in the vortex. Joins should begin on the near side and extract info from the far side.</comment>
  <add>5.28</add>
  <log>false</log>
  <icon>fa-handshake-o</icon>

  <field>
    <name>id</name>
    <type>int unsigned</type>
    <title>Relationship ID</title>
    <required>true</required>
    <comment>Relationship ID</comment>
    <add>5.28</add>
  </field>
  <primaryKey>
    <name>id</name>
    <autoincrement>true</autoincrement>
  </primaryKey>

  <field>
    <name>relationship_id</name>
    <type>int unsigned</type>
    <title>Relationship</title>
    <required>true</required>
    <comment>id of the relationship</comment>
    <add>5.28</add>
    <html>
      <type>Select</type>
    </html>
  </field>
  <foreignKey>
    <name>relationship_id</name>
    <table>civicrm_relationship</table>
    <key>id</key>
    <add>5.28</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <field>
    <name>relationship_type_id</name>
    <type>int unsigned</type>
    <title>Relationship Type</title>
    <required>true</required>
    <comment>id of the relationship</comment>
    <add>5.28</add>
    <html>
      <type>Select</type>
    </html>
  </field>
  <foreignKey>
    <name>relationship_type_id</name>
    <table>civicrm_relationship_type</table>
    <key>id</key>
    <add>5.28</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <field>
    <name>orientation</name>
    <type>int unsigned</type>
    <title>Orientation (A/B or B/A)</title>
    <required>true</required>
    <default>0</default>
    <comment>The vortex record is a permutation of the original relationship record. The orientation indicates whether it is forward (0; A/B) or reverse (1; B/A) relationship.</comment>
    <add>5.28</add>
  </field>

  <field>
    <name>near_type</name>
    <type>varchar</type>
    <title>Relationship Name (Near side)</title>
    <length>64</length>
    <comment>name for relationship of near_contact to far_contact.</comment>
    <add>5.28</add>
  </field>
  <field>
    <name>near_contact_id</name>
    <type>int unsigned</type>
    <title>Contact ID (Near side)</title>
    <required>true</required>
    <comment>id of the first contact</comment>
    <add>5.28</add>
  </field>
  <foreignKey>
    <name>near_contact_id</name>
    <table>civicrm_contact</table>
    <key>id</key>
    <add>5.28</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <field>
    <name>far_type</name>
    <type>varchar</type>
    <title>Relationship Name (Far side)</title>
    <length>64</length>
    <comment>name for relationship of far_contact to far_contact.</comment>
    <add>5.28</add>
  </field>
  <field>
    <name>far_contact_id</name>
    <type>int unsigned</type>
    <title>Contact ID (Far side)</title>
    <required>true</required>
    <comment>id of the second contact</comment>
    <add>5.28</add>
    <html>
      <type>EntityRef</type>
    </html>
  </field>
  <foreignKey>
    <name>far_contact_id</name>
    <table>civicrm_contact</table>
    <key>id</key>
    <add>5.28</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <index>
    <name>UI_relationship</name>
    <fieldName>relationship_id</fieldName>
    <fieldName>orientation</fieldName>
    <unique>true</unique>
    <add>5.28</add>
  </index>
  <index>
    <!-- Ex: select ... from contact inner join vtx on contact.id=vtx.near_contact_id and near_type = 'foo' -->
    <name>index_nearid_neartype</name>
    <fieldName>near_contact_id</fieldName>
    <fieldName>near_type</fieldName>
    <add>5.28</add>
  </index>
  <index>
    <!-- Ex: select near_type, count(*) from vtx group by near_type -->
    <name>index_neartype</name>
    <fieldName>near_type</fieldName>
    <add>5.28</add>
  </index>
  <index>
    <!-- Ex: select ... from contact inner join vtx on contact.id=vtx.near_contact_id and far_type = 'bar' -->
    <name>index_nearid_fartype</name>
    <fieldName>near_contact_id</fieldName>
    <fieldName>far_type</fieldName>
    <add>5.28</add>
  </index>
</table>
